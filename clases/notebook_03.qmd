---
listing_title: "Clase 03"
title: |
  | \includegraphics[width=5cm]{Imagen5.png}  
  | ECO5008 Modelos predictivos
subtitle: Clase 03 - Modelos Predictivos en la Gesti√≥n de Inventario M√©dico
format: pdf
editor: visual
author:   
  - Sebasti√°n Ega√±a Santib√°√±ez [{{< fa brands inbox >}}](mailto:segana@fen.uchile.cl)
code-block-bg: true
code-block-border-left: "#FF0000"
---

------------------------------------------------------------------------

# Enlaces del profesor

[{{< fa brands link >}}](https://segana.netlify.app) https://segana.netlify.app

[{{< fa brands github >}}](https://github.com/sebaegana) https://github.com/sebaegana

[{{< fa brands linkedin >}}](https://www.linkedin.com/in/sebastian-egana-santibanez/) https://www.linkedin.com/in/sebastian-egana-santibanez/

------------------------------------------------------------------------

```{r load_packages, message=FALSE, warning=FALSE, include=FALSE}
library(fontawesome)
library(knitr)
library(tidyverse)
```

# Clase 03

# Conceptos iniciales

## üß≠ ¬øQu√© es la gesti√≥n de inventarios?

Proceso de **planificar, controlar y optimizar** la disponibilidad de insumos m√©dicos para:

-   Evitar quiebres de stock (falta de insumos cr√≠ticos).
-   Reducir sobreinventario y costos asociados.
-   Asegurar la continuidad de las operaciones cl√≠nicas y hospitalarias.

## üè• Importancia en salud

-   Medicamentos, reactivos, guantes, vacunas, etc.
-   Vencimientos y control de temperatura.
-   Costo de oportunidad de un quiebre: puede afectar una cirug√≠a o atenci√≥n cr√≠tica.
-   Balance entre **seguridad del paciente** y **eficiencia operativa**.

## ‚öôÔ∏è Componentes de un sistema de inventario

| Concepto | Definici√≥n | Ejemplo |
|-------------------------|---------------------------|---------------------|
| **Demanda (D)** | Cantidad requerida en un per√≠odo. | Guantes por d√≠a |
| **Lead time (L)** | Tiempo entre emitir y recibir un pedido. | 4 d√≠as |
| **Costo de ordenar (K)** | Costo fijo por orden | Tr√°mite y transporte |
| **Costo de mantener (h)** | Costo anual por unidad almacenada. | Refrigeraci√≥n, espacio |
| **Costo de quiebre (p)** | Costo de no disponer de stock. | Suspensi√≥n de atenci√≥n |

## üîÅ Tipos de pol√≠ticas

| Tipo | Descripci√≥n | Notaci√≥n |
|------------------|------------------------------|------------------------|
| **Revisi√≥n continua** | Se repone cuando el inventario baja a un umbral $R$ | Pol√≠tica (Q, R) |
| **Revisi√≥n peri√≥dica** | Se revisa en intervalos fijos de tiempo. | Pol√≠tica (s, S) |

‚û°Ô∏è Usaremos **revisi√≥n continua (Q,R)**:\
- $Q$: cantidad que se pide cada vez.\
- $R$: punto que activa el pedido.

## üìà Tipos de demanda

| Tipo               | Caracter√≠stica               | Aplicaci√≥n             |
|--------------------|------------------------------|------------------------|
| **Determin√≠stica** | Conocida con certeza.        | Insumos rutinarios.    |
| **Probabil√≠stica** | Aleatoria, con distribuci√≥n. | Medicamentos urgentes. |

üëâ En contextos m√©dicos, la demanda suele modelarse como **Poisson**:

$$
X_t \sim \text{Poisson}(\lambda)
$$

donde $\lambda$ = tasa promedio diaria de consumo.

## üìä Variables principales

| S√≠mbolo | Nombre              | Interpretaci√≥n                       |
|---------|---------------------|--------------------------------------|
| $D$     | Demanda anual       | $\lambda \times \text{d√≠as por a√±o}$ |
| $K$     | Costo de ordenar    | Costo fijo por pedido                |
| $h$     | Costo de mantener   | Por unidad-a√±o                       |
| $Q$     | Cantidad pedida     | Tama√±o del pedido                    |
| $R$     | Punto de pedido     | Nivel que activa la orden            |
| $L$     | Lead time           | Tiempo de entrega                    |
| $CSL$   | Cycle Service Level | Probabilidad de no quiebre           |

### üí∞ ¬øQu√© es el costo del pedido?

Corresponde a **todos los costos fijos asociados a emitir y recibir una orden de compra**, independientes de cu√°ntas unidades se pidan.

$$
K = \text{Costo fijo por pedido (no depende de la cantidad pedida)}
$$

### üßæ Ejemplos hospitalarios

| Tipo de costo | Descripci√≥n | Ejemplo |
|-----------------------------|------------------------|-------------------|
| **Administrativo** | Tiempo y personal para emitir la orden de compra. | Funcionario que gestiona el pedido. |
| **Transporte y recepci√≥n** | Gastos fijos de entrega. | Cami√≥n o courier. |
| **Inspecci√≥n y registro** | Control y registro del lote recibido. | Verificaci√≥n de guantes o vacunas. |
| **Procesamiento interno** | Costos de sistema o contabilidad. | Registro en ERP o SIGA. |
| **Oportunidad operativa** | Tiempo que se detiene por el proceso de compra. | Coordinaci√≥n con bodega y proveedor. |

Estos costos ocurren **cada vez que se hace un pedido**, sin importar el tama√±o.

\newpage

## ‚öñÔ∏è Modelo EOQ (Economic Order Quantity)

Minimiza el **costo total anual**:

$$
C(Q) = \frac{K D}{Q} + \frac{h Q}{2}
$$

-   Primer t√©rmino ‚Üí costo de ordenar
-   Segundo t√©rmino ‚Üí costo de mantener

El punto √≥ptimo ocurre cuando ambos costos son iguales:

$$
Q^* = \sqrt{\frac{2KD}{h}}
$$

## üì¶ Punto de pedido $R$

Durante el lead time puede haber demanda aleatoria. Por eso se define el **punto de pedido**:

$$
R = \text{Demanda esperada en el lead time} + \text{Stock de seguridad}
$$

El **stock de seguridad (SS)** se ajusta al nivel de servicio deseado:

$$
SS = z \cdot \sigma_L \quad \text{o, para demanda Poisson,} \quad R = qpois(CSL, \lambda L)
$$

## ü§ñ Rol de los modelos predictivos

Los modelos predictivos permiten estimar: - La demanda futura $\hat{D}$ o $\hat{\lambda}$ - El riesgo de quiebre y niveles √≥ptimos de servicio - Los costos esperados bajo distintas pol√≠ticas (Q, R)

‚û°Ô∏è As√≠ respondemos a tres preguntas clave:

1.  **¬øCu√°nto pedir?** $(Q)$
2.  **¬øCu√°ndo pedir?** $(R)$
3.  **¬øQu√© nivel de servicio ofrecer?** $(CSL)$

## üß© En resumen

-   La gesti√≥n de inventario m√©dico combina **log√≠stica y anal√≠tica**
-   Los modelos predictivos ayudan a anticipar la demanda
-   EOQ y Poisson permiten decidir racionalmente **cantidad y momento √≥ptimo** de pedido
-   En la siguiente parte: aplicaremos estas ideas en un **caso pr√°ctico**

# Ejercicio: EOQ y punto de pedido con demanda Poisson

## üéØ Objetivo de la clase

Aplicar modelos predictivos para **optimizar el inventario m√©dico** mediante:

-   C√°lculo de la **Cantidad Econ√≥mica de Pedido (EOQ)**
-   Determinaci√≥n del **Punto de Pedido (R)** con demanda Poisson
-   Interpretaci√≥n del **nivel de servicio (CSL)**

## üè• Contexto del caso

Un hospital gestiona guantes est√©riles.

| Par√°metro | Valor       | Descripci√≥n                       |
|-----------|-------------|-----------------------------------|
| Œª         | 15 unid/d√≠a | Demanda promedio (Poisson)        |
| D√≠as/a√±o  | 300         | Operaciones anuales               |
| L         | 4 d√≠as      | Lead time de reposici√≥n           |
| K         | \$120       | Costo de ordenar                  |
| h         | \$8         | Costo anual por unidad almacenada |
| CSL       | 95%         | Nivel de servicio deseado         |

## 1Ô∏è‚É£ Demanda anual

$$
D = \lambda \times 300 = 15 \times 300 = 4{,}500\ \text{unidades/a√±o}
$$

## 2Ô∏è‚É£ EOQ ‚Äì Cantidad econ√≥mica de pedido

**F√≥rmula general:**

$$
Q^* = \sqrt{\frac{2KD}{h}}
$$

**C√°lculo:**

$$
Q^* = \sqrt{\frac{2(120)(4500)}{8}} = \sqrt{135{,}000} \approx 367
$$

‚úÖ Se recomienda pedir **367 unidades por orden**.

## 3Ô∏è‚É£ Demanda durante el lead time

Demanda aleatoria: $$
X \sim \text{Poisson}(\lambda L)
$$ $$
\mathbb{E}[X] = 15 \times 4 = 60
$$

Buscamos el **punto de pedido R** tal que:

$$
\Pr(X \le R) \ge 0.95
$$

## 4Ô∏è‚É£ C√°lculo del punto de pedido

### Aproximaci√≥n Normal

$$
R \approx 60 + 1.64\sqrt{60} = 72.7 \approx 73
$$

### C√°lculo exacto (cuantil Poisson):

$$
R = qpois(0.95, 60) = 73
$$

üßÆ **Stock de seguridad:**

$$
SS = R - \lambda L = 73 - 60 = 13
$$

## 5Ô∏è‚É£ Costo total anual

$$
C(Q^*) = \frac{K D}{Q^*} + \frac{h Q^*}{2}
$$

$$
C(Q^*) = \frac{120(4500)}{367} + \frac{8(367)}{2}
\approx 1{,}470 + 1{,}470 = 2{,}940
$$

üí∞ **Costo total anual:** ‚âà \$2.940

## üìä Resultados clave

| Concepto   | Valor    | Interpretaci√≥n           |
|------------|----------|--------------------------|
| (Q\^\*)    | 367 unid | Tama√±o √≥ptimo del pedido |
| \(R\)      | 73 unid  | Punto de reposici√≥n      |
| (SS)       | 13 unid  | Colch√≥n de seguridad     |
| (C(Q\^\*)) | \$2.940  | Costo anual m√≠nimo       |

## üíª C√≥digo en R

```{r}
lambda <- 15
days <- 300
D <- lambda * days
L <- 4
K <- 120
h <- 8
CSL <- 0.95

Q_star <- sqrt(2*K*D/h)
R <- qpois(CSL, lambda*L)
C_annual <- K*D/Q_star + h*Q_star/2

list(Q_star=Q_star, R=R, C_annual=C_annual)
```

```{r}
# Par√°metros
lambda <- 15      # demanda diaria
days   <- 300
D      <- lambda * days
L      <- 4
K      <- 120
h      <- 8
CSL    <- 0.95

# 1) EOQ
Q_star <- sqrt(2*K*D/h)

# 2) Punto de pedido con Poisson
R <- qpois(CSL, lambda = lambda*L)

# 3) Costo anual con Q*
C_annual <- K*D/Q_star + h*Q_star/2

list(Q_star = Q_star, R = R, C_annual = C_annual)

# ---- Simulaci√≥n simple de 1 a√±o (demanda diaria Poisson, pol√≠tica (Q*,R)) ----
set.seed(123)
Q <- round(Q_star)
inv <-  Q          # inventario inicial
on_order <- 0      # unidades en tr√°nsito
lt_queue <- integer(0) # cola de llegadas: d√≠as restantes hasta arribo

stockouts <- 0
orders <- 0

for (t in 1:days) {
  # Arribos
  if (length(lt_queue) > 0 && lt_queue[1] == 0) {
    inv <- inv + on_order
    on_order <- 0
    lt_queue <- lt_queue[-1]
  }
  lt_queue <- lt_queue - 1

  # Demanda del d√≠a
  d <- rpois(1, lambda)
  if (d <= inv) {
    inv <- inv - d
  } else {
    # quiebre (sin backorder en esta versi√≥n)
    stockouts <- stockouts + (d - inv)
    inv <- 0
  }

  # Revisi√≥n continua: si inventario <= R y no hay pedido en tr√°nsito, ordenar Q
  if (inv <= R && on_order == 0) {
    on_order <- Q
    lt_queue <- c(lt_queue, L) # llega en L d√≠as
    orders <- orders + 1
  }
}

list(orders = orders, stockouts = stockouts, end_inventory = inv)
```

```{r}
#| message: false
#| warning: false
library(dplyr)
library(ggplot2)
library(tidyr)

# Par√°metros
lambda <- 15      # demanda diaria
days   <- 300
D      <- lambda * days
L      <- 4
K      <- 120
h      <- 8
CSL    <- 0.95

# 1) EOQ y R
Q_star <- sqrt(2*K*D/h)
Q <- round(Q_star)
R <- qpois(CSL, lambda = lambda*L)

# 2) Simulaci√≥n diaria (revisi√≥n continua (Q,R))
set.seed(123)
inv <- Q                 # inventario on-hand (inicial: un pedido completo)
on_order <- 0            # unidades en tr√°nsito (0 al inicio)
lt_queue <- integer(0)   # cola de d√≠as hasta arribo de cada pedido

df <- tibble(
  day        = integer(),
  demand     = integer(),
  inv_onhand = integer(),
  inv_pos    = integer(), # posici√≥n: on-hand + on-order
  order_placed = integer(),
  arrival      = integer(),
  stockout_units = integer()
)

orders <- 0
cum_stockouts <- 0

for (t in 1:days) {

  arrival_flag <- 0
  # Arribo si corresponde (primero comprobamos arribo de pedidos previos)
  if (length(lt_queue) > 0 && lt_queue[1] == 0) {
    inv <- inv + on_order
    on_order <- 0
    lt_queue <- lt_queue[-1]
    arrival_flag <- 1
  }
  # Luego, corremos el reloj de los pedidos en tr√°nsito
  if (length(lt_queue) > 0) lt_queue <- lt_queue - 1

  # Demanda Poisson del d√≠a
  d <- rpois(1, lambda)
  stockout_today <- 0
  if (d <= inv) {
    inv <- inv - d
  } else {
    stockout_today <- d - inv
    inv <- 0
  }
  cum_stockouts <- cum_stockouts + stockout_today

  # Pol√≠tica (Q,R): si inv <= R y NO hay pedido en tr√°nsito, emitir pedido Q
  order_flag <- 0
  if (inv <= R && on_order == 0) {
    on_order <- Q
    lt_queue <- c(lt_queue, L)  # llegar√° en L d√≠as
    orders <- orders + 1
    order_flag <- 1
  }

  inv_pos <- inv + on_order

  df <- bind_rows(df, tibble(
    day = t,
    demand = d,
    inv_onhand = inv,
    inv_pos = inv_pos,
    order_placed = order_flag,
    arrival = arrival_flag,
    stockout_units = stockout_today
  ))
}

df <- df %>% mutate(cum_stockouts = cumsum(stockout_units))
resumen <- list(
  Q_star = Q_star, R = R,
  orders = orders,
  end_inventory = df$inv_onhand[days],
  total_stockouts = sum(df$stockout_units)
)
resumen
```

```{r}
ggplot(df, aes(day, inv_onhand)) +
geom_line() +
geom_hline(yintercept = R, linetype = 2) +
labs(title = "Trayectoria del inventario (on-hand)",
x = "D√≠a", y = "Unidades") +
annotate("text", x = max(df$day)*0.85, y = R + 5, label = paste0("R = ", R))

```

```{r}
ggplot(df, aes(day, inv_onhand)) +
geom_line() +
geom_point(data = df %>% filter(order_placed == 1),
aes(day, inv_onhand), shape = 24, size = 2) +  # tri√°ngulo: pedido
geom_point(data = df %>% filter(arrival == 1),
aes(day, inv_onhand), shape = 21, size = 2) +  # c√≠rculo: arribo
geom_hline(yintercept = R, linetype = 2) +
labs(title = "Inventario con eventos (pedidos y arribos)",
x = "D√≠a", y = "Unidades",
caption = "‚ñ≤ = pedido emitido | ‚óã = pedido recibido")

```

```{r}
ggplot(df, aes(day, cum_stockouts)) +
geom_line() +
labs(title = "Demanda insatisfecha acumulada (stockouts)",
x = "D√≠a", y = "Unidades acumuladas")


```

```{r}
ggplot(df, aes(demand)) +
geom_histogram(binwidth = 1, boundary = 0, closed = "left") +
labs(title = "Distribuci√≥n de la demanda diaria (Poisson)",
x = "Unidades por d√≠a", y = "Frecuencia")

```

**Notas did√°cticas:**

-   La **l√≠nea discontinua** indica el **punto de pedido R**. Ver√°s que los **pedidos** se emiten justo cuando el inventario baja a ese nivel.\
-   El **salto** en el inventario coincide con un **arribo** tras $L$ d√≠as.\
-   El gr√°fico de **stockouts** te muestra si, pese al $CSL=95\%$, hubo demanda no atendida (deber√≠a ser baja/ocasional).\
-   El **histograma** ayuda a explicar por qu√© necesitamos **stock de seguridad**: la demanda diaria fluct√∫a.
